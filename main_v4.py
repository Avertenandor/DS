"""
PLEX Dynamic Staking Manager - Main Application Entry Point V4
Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ² Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ñ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¼ UI.

ĞĞ²Ñ‚Ğ¾Ñ€: PLEX Dynamic Staking Team
Ğ’ĞµÑ€ÑĞ¸Ñ: 4.0.0
"""

import os
import sys
import traceback
from datetime import datetime

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ñ€Ğ½ĞµĞ²Ğ¾Ğ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ² Ğ¿ÑƒÑ‚ÑŒ
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, BASE_DIR)

from utils.logger import get_logger
from config.constants import *
from config.settings import settings

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
logger = get_logger(__name__)


def check_dependencies():
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹."""
    missing_deps = []
    
    try:
        import customtkinter
    except ImportError:
        missing_deps.append("customtkinter")
    
    try:
        import web3
    except ImportError:
        missing_deps.append("web3")
    
    try:
        import requests
    except ImportError:
        missing_deps.append("requests")
    
    try:
        import sqlite3
    except ImportError:
        missing_deps.append("sqlite3")
    
    if missing_deps:
        print("âŒ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸:")
        for dep in missing_deps:
            print(f"   - {dep}")
        print("\\nğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸: pip install -r requirements.txt")
        return False
    
    return True


def print_banner():
    """ĞŸĞµÑ‡Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ½Ğ½ĞµÑ€Ğ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ."""
    banner = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                              â•‘
â•‘        ğŸ’ PLEX Dynamic Staking Manager v4.0                 â•‘
â•‘                                                              â•‘
â•‘        ğŸ”— BSC Network Analysis & Reward Distribution         â•‘
â•‘        ğŸ“Š Advanced Participant Analytics                     â•‘
â•‘        ğŸ Automated Reward Calculation                       â•‘
â•‘        ğŸ“š Complete Operation History                         â•‘
â•‘        âš™ï¸ Comprehensive Settings                             â•‘
â•‘                                                              â•‘
â•‘        ĞĞ²Ñ‚Ğ¾Ñ€: PLEX Dynamic Staking Team                      â•‘
â•‘        Ğ’Ñ€ĞµĞ¼Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}                     â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    print(banner)


def main():
    """Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ."""
    try:
        # ĞŸĞµÑ‡Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ½Ğ½ĞµÑ€Ğ°
        print_banner()
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
        print("ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹...")
        if not check_dependencies():
            return 1
        print("âœ… Ğ’ÑĞµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹")
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
        print("âš™ï¸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸...")
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ .env Ñ„Ğ°Ğ¹Ğ»Ğ°
        env_file = os.path.join(BASE_DIR, '.env')
        if not os.path.exists(env_file):
            print("âš ï¸ Ğ¤Ğ°Ğ¹Ğ» .env Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ ĞµĞ³Ğ¾ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ .env.example")
            print("ğŸ“ Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ .env.example Ğ² .env Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹")
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ñ… Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº
        if not hasattr(settings, 'QUICKNODE_RPC_URL') or not settings.QUICKNODE_RPC_URL:
            print("âš ï¸ QuickNode RPC URL Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½")
            print("ğŸ’¡ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹Ñ‚Ğµ ĞµĞ³Ğ¾ Ğ²Ğ¾ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞµ 'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸' Ğ¸Ğ»Ğ¸ Ğ² Ñ„Ğ°Ğ¹Ğ»Ğµ .env")
        
        print("âœ… ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ°")
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹
        print("ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹...")
        directories = ['logs', 'backups', 'exports', 'cache']
        for directory in directories:
            dir_path = os.path.join(BASE_DIR, directory)
            os.makedirs(dir_path, exist_ok=True)
        print("âœ… Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹")
        
        # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ‘Ğ”
        print("ğŸ—„ï¸ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...")
        try:
            from db.database import DatabaseManager
            db_manager = DatabaseManager()
            db_manager.initialize_database()
            print("âœ… Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°")
        except Exception as e:
            print(f"âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ‘Ğ”: {e}")
            logger.warning(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ‘Ğ”: {e}")
        
        # Ğ—Ğ°Ğ¿ÑƒÑĞº GUI
        print("ğŸ¨ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ³Ğ¾ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°...")
        logger.info("ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº PLEX Dynamic Staking Manager v4.0")
        
        from ui.main_window_v4 import PLEXStakingMainWindow
        
        app = PLEXStakingMainWindow()
        app.run()
        
        print("ğŸ‘‹ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾")
        logger.info("ğŸ‘‹ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾")
        return 0
        
    except KeyboardInterrupt:
        print("\\nâ¹ï¸ ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼")
        logger.info("ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼")
        return 0
        
    except Exception as e:
        print(f"\\nâŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
        print("\\nğŸ“‹ Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸:")
        traceback.print_exc()
        
        logger.error(f"ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
        logger.error(f"Ğ¢Ñ€Ğ°ÑÑĞ¸Ñ€Ğ¾Ğ²ĞºĞ°: {traceback.format_exc()}")
        
        return 1


if __name__ == "__main__":
    exit_code = main()
    sys.exit(exit_code)
